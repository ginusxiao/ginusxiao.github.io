# 提纲
[toc]

# 成员组管理相关数据结构
## SystemVSM
```
class SystemVSM : public InsideSM 
{
private:
    int m_iMyGroupIdx;
    SystemVariables m_oSystemVariables;
    SystemVariablesStore m_oSystemVStore;

    std::set<nodeid_t> m_setNodeID;

    nodeid_t m_iMyNodeID;

    MembershipChangeCallback m_pMembershipChangeCallback;
};
```

## SystemVariables
```
class SystemVariables : public ::google::protobuf::Message {
public:
    ::google::protobuf::uint64 gid_;
    ::google::protobuf::RepeatedPtrField< ::phxpaxos::PaxosNodeInfo > membership_;
    ::google::protobuf::uint64 version_;
};
```

## SystemVariablesStore
```
class SystemVariablesStore
{
public:
    SystemVariablesStore(const LogStorage * poLogStorage);
    ~SystemVariablesStore();

    int Write(const WriteOptions & oWriteOptions,  const int iGroupIdx, const SystemVariables & oVariables);

    int Read(const int iGroupIdx, SystemVariables & oVariables);

private:
    LogStorage * m_poLogStorage;
};
```


# 成员组管理相关的方法
## SystemVariablesStore相关方法
### 将SystemVariables写入SystemVariablesStore
```
int SystemVariablesStore :: Write(const WriteOptions & oWriteOptions, const int iGroupIdx, const SystemVariables & oVariables)
{
    const int m_iMyGroupIdx = iGroupIdx;

    /*将SystemVariables序列化为字符串*/
    string sBuffer;
    bool sSucc = oVariables.SerializeToString(&sBuffer);
    if (!sSucc)
    {
        PLG1Err("Variables.Serialize fail");
        return -1;
    }
    
    /* 实际调用MultiDatabase :: SetSystemVariables，最终将{key: SYSTEMVARIABLES_KEY,
     * val: sBuffer}写入leveldb中
     */
    int ret = m_poLogStorage->SetSystemVariables(oWriteOptions, iGroupIdx, sBuffer);
    if (ret != 0)
    {
        PLG1Err("DB.Put fail, groupidx %d bufferlen %zu ret %d", 
                iGroupIdx, sBuffer.size(), ret);
        return ret;
    }

    return 0;
}
```

### 从SystemVariablesStore中读取SystemVariables
```
int SystemVariablesStore :: Read(const int iGroupIdx, SystemVariables & oVariables)
{
    const int m_iMyGroupIdx = iGroupIdx;

    /* 实际调用MultiDatabase :: GetSystemVariables，从leveldb中读取key为
     * SYSTEMVARIABLES_KEY对应的value，存放在@sBuffer中
     */
    string sBuffer;
    int ret = m_poLogStorage->GetSystemVariables(iGroupIdx, sBuffer);
    if (ret != 0 && ret != 1)
    {
        PLG1Err("DB.Get fail, groupidx %d ret %d", iGroupIdx, ret);
        return ret;
    }
    else if (ret == 1)
    {
        /*在leveldb中未找到key为SYSTEMVARIABLES_KEY的键值对*/
        PLG1Imp("DB.Get not found, groupidx %d", iGroupIdx);
        return 1;
    }

    /*解析@sBuffer到@oVariables中*/
    bool bSucc = oVariables.ParseFromArray(sBuffer.data(), sBuffer.size());
    if (!bSucc)
    {
        PLG1Err("Variables.ParseFromArray fail, bufferlen %zu", sBuffer.size());
        return -1;
    }

    return 0;
}
```

## SystemVSM相关方法
### SystemVSM初始化

```
int SystemVSM :: Init()
{
    /*从SystemVariablesStore中去读SystemVariables*/
    int ret = m_oSystemVStore.Read(m_iMyGroupIdx, m_oSystemVariables);
    if (ret != 0 && ret != 1)
    {
        return ret;
    }

    if (ret == 1)
    {
        /*在SystemVariablesStore中没有找到，初始化Gid和version*/
        m_oSystemVariables.set_gid(0);
        m_oSystemVariables.set_version(-1);
        PLG1Imp("variables not exist");
    }
    else
    {
        RefleshNodeID();
        PLG1Imp("OK, gourpidx %d gid %lu version %lu", 
                m_iMyGroupIdx, m_oSystemVariables.gid(), m_oSystemVariables.version());
    }

    return 0;
}
```

### 添加集群节点信息

```
Node :: RunNode
    - Group :: StartInit
        - Group :: Init
            - Config :: Init
                - SystemVSM :: AddNodeIDList
                
void SystemVSM :: AddNodeIDList(const NodeInfoList & vecNodeInfoList)
{
    /*如果Gid不为0，则集群成员组信息已经存在*/
    if (m_oSystemVariables.gid() != 0)
    {
        PLG1Err("No need to add, i already have membership info.");
        return;
    }

    /*清理已有的成员节点信息*/
    m_setNodeID.clear();
    m_oSystemVariables.clear_membership();

    /*更新成员信息到@m_oSystemVariables中*/
    for (auto & tNodeInfo : vecNodeInfoList)
    {
        PaxosNodeInfo * poNodeInfo = m_oSystemVariables.add_membership();
        //to do, what rid?
        poNodeInfo->set_rid(0);
        poNodeInfo->set_nodeid(tNodeInfo.GetNodeID());

        NodeInfo tTmpNode(poNodeInfo->nodeid());
    }

    /*通过@m_oSystemVariables中记录的成员信息更新@m_setNodeID*/
    RefleshNodeID();
}
```

### 初始化成员组Gid信息

```
int SystemVSM :: CreateGid_OPValue(const uint64_t llGid, std::string & sOpValue)
{
    SystemVariables oVariables = m_oSystemVariables;
    /*设置Gid*/
    oVariables.set_gid(llGid);
    
    /*@oVariables序列化成字符串@sOpValue*/
    bool sSucc = oVariables.SerializeToString(&sOpValue);
    if (!sSucc)
    {
        PLG1Err("Variables.Serialize fail");
        return -1;
    }

    return 0;
}
```

### 根据新的集群节点信息生成成员组变更提议

```
int SystemVSM :: Membership_OPValue(const NodeInfoList & vecNodeInfoList, const uint64_t llVersion, std::string & sOpValue)
{
    SystemVariables oVariables;
    //must must set version first!
    oVariables.set_version(llVersion);
    oVariables.set_gid(m_oSystemVariables.gid());
    
    /*将新的集群节点添加到@oVariables中*/
    for (auto & tNodeInfo : vecNodeInfoList)
    {
        PaxosNodeInfo * poNodeInfo = oVariables.add_membership();
        //to do, what rid?
        poNodeInfo->set_rid(0);
        poNodeInfo->set_nodeid(tNodeInfo.GetNodeID());
    }

    /*将@oVariables序列化*/
    bool sSucc = oVariables.SerializeToString(&sOpValue);
    if (!sSucc)
    {
        PLG1Err("Variables.Serialize fail");
        return -1;
    }

    return 0;
}
```

### 尝试更新SystemVariables

```
/* @sCPBuffer: 输入，待更新的内容
 * @bChange: 输出，是否执行了更新
 */
int SystemVSM :: UpdateByCheckpoint(const std::string & sCPBuffer, bool & bChange)
{
    if (sCPBuffer.size() == 0)
    {
        return 0;
    }
    
    bChange = false;
    
    /*从@sCPBuffer中解析出@oVariables*/
    SystemVariables oVariables;
    bool bSucc = oVariables.ParseFromArray(sCPBuffer.data(), sCPBuffer.size());
    if (!bSucc)
    {
        PLG1Err("Variables.ParseFromArray fail, bufferlen %zu", sCPBuffer.size());
        return -1;
    }

    if (oVariables.version() == (uint64_t)-1)
    {
        PLG1Err("variables.version not init, this is not checkpoint");
        return -2;
    }

    /*本地记录的Gid有效，但是更新的内容中携带的Gid和本地记录的Gid不匹配*/
    if (m_oSystemVariables.gid() != 0 
            && oVariables.gid() != m_oSystemVariables.gid())
    {
        PLG1Err("gid not same, cp.gid %lu now.gid %lu", oVariables.gid(), m_oSystemVariables.gid());
        return -2;
    }

    /*本地记录的Version有效，但是更新的内容中携带的Version和本地记录的Version不匹配*/
    if (m_oSystemVariables.version() != (uint64_t)-1 
            && oVariables.version() <= m_oSystemVariables.version())
    {
        PLG1Imp("lag checkpoint, no need update, cp.version %lu now.version %lu",
                oVariables.version(), m_oSystemVariables.version());
        return 0;
    }

    /*更新之*/
    bChange = true;
    SystemVariables oOldVariables = m_oSystemVariables;

    int ret = UpdateSystemVariables(oVariables);
    if (ret != 0)
    {
        return -1;
    }

    PLG1Head("ok, cp.version %lu cp.membercount %d old.version %lu old.membercount %d", 
            oVariables.version(), oVariables.membership_size(),
            oOldVariables.version(), oOldVariables.membership_size());

    return 0;
}

int SystemVSM :: UpdateSystemVariables(const SystemVariables & oVariables)
{
    WriteOptions oWriteOptions;
    oWriteOptions.bSync = true;

    /*将新的SystemVariables @oVariables写入SystemVariablesStore*/
    int ret = m_oSystemVStore.Write(oWriteOptions, m_iMyGroupIdx, oVariables);
    if (ret != 0)
    {
        PLG1Err("SystemVStore::Write fail, ret %d", ret);
        return -1;
    }

    m_oSystemVariables = oVariables;

    /*更新@m_setNodeID中记录的节点信息*/
    RefleshNodeID();

    return 0;
}

```

### 更新集群节点ID信息集合

```
void SystemVSM :: RefleshNodeID()
{
    m_setNodeID.clear();

    NodeInfoList vecNodeInfoList;
    
    /* 将@m_oSystemVariables中记录的成员信息更新到@m_setNodeID中，
     * 并触发注册的成员组变更的回调函数
     */
    for (int i = 0; i < m_oSystemVariables.membership_size(); i++)
    {
        PaxosNodeInfo oNodeInfo = m_oSystemVariables.membership(i);
        NodeInfo tTmpNode(oNodeInfo.nodeid());

        PLG1Head("ip %s port %d nodeid %lu", 
                tTmpNode.GetIP().c_str(), tTmpNode.GetPort(), tTmpNode.GetNodeID());

        /*更新@m_setNodeID*/
        m_setNodeID.insert(tTmpNode.GetNodeID());

        vecNodeInfoList.push_back(tTmpNode);
    }

    /*如果注册了成员组变更的回调，则触发之*/
    if (m_pMembershipChangeCallback != nullptr)
    {
        m_pMembershipChangeCallback(m_iMyGroupIdx, vecNodeInfoList);
    }
}
```

### 在状态机上执行决议
```
bool SystemVSM :: Execute(const int iGroupIdx, const uint64_t llInstanceID, const std::string & sValue, SMCtx * poSMCtx)
{
    /*从@sValue中解析出@oVariables*/
    SystemVariables oVariables;
    bool bSucc = oVariables.ParseFromArray(sValue.data(), sValue.size());
    if (!bSucc)
    {
        PLG1Err("Variables.ParseFromArray fail, bufferlen %zu", sValue.size());
        return false;
    }

    int * smret = nullptr;
    if (poSMCtx != nullptr && poSMCtx->m_pCtx != nullptr)
    {
        smret = (int *)poSMCtx->m_pCtx;
    }

    /*Gid不匹配*/
    if (m_oSystemVariables.gid() != 0 && oVariables.gid() != m_oSystemVariables.gid())
    {
        PLG1Err("modify.gid %lu not equal to now.gid %lu", oVariables.gid(), m_oSystemVariables.gid());
        if (smret != nullptr) *smret = Paxos_MembershipOp_GidNotSame;
        return true;
    }

    /*Version不匹配*/
    if (oVariables.version() != m_oSystemVariables.version())
    {
        PLG1Err("modify.version %lu not equal to now.version %lu", oVariables.version(), m_oSystemVariables.version());
        if (smret != nullptr) *smret = Paxos_MembershipOp_VersionConflit;
        return true;
    }

    /*以@llInstanceID作为version*/
    oVariables.set_version(llInstanceID);
    /*更新SystemVariables*/
    int ret = UpdateSystemVariables(oVariables);
    if (ret != 0)
    {
        return false;
    }

    PLG1Head("OK, new version %lu gid %lu", m_oSystemVariables.version(), m_oSystemVariables.gid());

    if (smret != nullptr) *smret = 0;

    return true;
}
```

## Node中关于成员组变更（add，change，remove）管理的接口
### 发起成员组变更的提议

```
int PNode :: ProposalMembership(
        SystemVSM * poSystemVSM, 
        const int iGroupIdx, 
        const NodeInfoList & vecNodeInfoList, 
        const uint64_t llVersion)
{
    /*准备成员组变更的提议*/
    string sOpValue;
    int ret = poSystemVSM->Membership_OPValue(vecNodeInfoList, llVersion, sOpValue);
    if (ret != 0)
    {
        return Paxos_SystemError;
    }

    SMCtx oCtx;
    int smret = -1;
    oCtx.m_iSMID = SYSTEM_V_SMID;
    
    /*返回值*/
    oCtx.m_pCtx = (void *)&smret;

    /*提交提议给Committer*/
    uint64_t llInstanceID = 0;
    ret = Propose(iGroupIdx, sOpValue, llInstanceID, &oCtx);
    if (ret != 0)
    {
        return ret;
    }

    return smret;
}
```

### 添加节点到成员组

```
int PNode :: AddMember(const int iGroupIdx, const NodeInfo & oNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /*集群尚未确定Gid*/
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    /*检查即将添加的节点是否已经在成员组中，如果在，则返回*/
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oNode.GetNodeID())
        {
            return Paxos_MembershipOp_Add_NodeExist;
        }
    }

    /* 添加到临时的成员组信息@vecNodeInfoList中，该临时成员组信息将用于
     * 发起成员组变更的提议
     */
    vecNodeInfoList.push_back(oNode);

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecNodeInfoList, llVersion);
}
```

### 更改成员组中的节点（信息）

```
/*将某个节点信息从@oFromNode更改为@oToNode*/
int PNode :: ChangeMember(const int iGroupIdx, const NodeInfo & oFromNode, const NodeInfo & oToNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /*集群尚未确定Gid*/
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    NodeInfoList vecAfterNodeInfoList;
    bool bFromNodeExist = false;
    bool bToNodeExist = false;
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oFromNode.GetNodeID())
        {
            bFromNodeExist = true;
            continue;
        }
        else if (oNodeInfo.GetNodeID() == oToNode.GetNodeID())
        {
            bToNodeExist = true;
            continue;
        }

        /*@vecAfterNodeInfoList中已经排除了@oFromNode和@oToNode*/
        vecAfterNodeInfoList.push_back(oNodeInfo);
    }

    /*@oFromNode不存在，则不更改*/
    if ((!bFromNodeExist) && bToNodeExist)
    {
        return Paxos_MembershipOp_Change_NoChange;
    }

    /*将@oToNode添加到@vecAfterNodeInfoList中，表示更改后的集群节点集合*/
    vecAfterNodeInfoList.push_back(oToNode);

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecAfterNodeInfoList, llVersion);
}
```

### 从成员组中删除节点

```
int PNode :: RemoveMember(const int iGroupIdx, const NodeInfo & oNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /*集群尚未确定Gid*/
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    bool bNodeExist = false;
    NodeInfoList vecAfterNodeInfoList;
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oNode.GetNodeID())
        {
            bNodeExist = true;
        }
        else
        {
            /*@vecAfterNodeInfoList中排除@oNode*/
            vecAfterNodeInfoList.push_back(oNodeInfo);
        }
    }

    if (!bNodeExist)
    {
        /*如果@oNode不在当前的成员组中，则直接返回*/
        return Paxos_MembershipOp_Remove_NodeNotExist;
    }

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecAfterNodeInfoList, llVersion);
}
```

### 获取当前的成员组信息

```
int PNode :: ShowMembership(const int iGroupIdx, NodeInfoList & vecNodeInfoList)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    uint64_t llVersion = 0;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    return 0;
}
```

# 在启用PhxPaxos内置的成员组管理的情况下变更成员的方法
如何开启成员管理，请参考[options.h参数中文说明](https://github.com/tencent-wechat/phxpaxos/wiki/options.h%E5%8F%82%E6%95%B0%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E)下的bUseMembership参数说明。

## 初始化集群成员组
- 准备好所有集群节点机器，机器启动PhxPaxos的时候设置好成员列表(Options::vecNodeInfoList)。
- 在任意一个节点发起一个Propose操作，即可完成集群初始化。
- 初始化操作会在所有节点都将这个成员列表固化到磁盘，并交由PhxPaxos管理，同时生成集群唯一的签名ID，当不同集群之间发生网络串包的时候，签名ID可以拒绝请求已保护集群数据的一致性。
- 当集群初始化完成后，可通过Node::ShowMembership获得当前集群的成员列表，并且在这之后，集群的节点启动将不再信任Options::vecNodeInfoList。

下面通过代码来具体分析上述步骤。
### 在启动PhxPaxos时在节点上设置成员组成员列表

```
int Node :: RunNode(const Options & oOptions, Node *& poNode)
{
    ......

    /*初始化Node*/
    PNode * poRealNode = new PNode();
    int ret = poRealNode->Init(oOptions, poNetWork);
    if (ret != 0)
    {
        delete poRealNode;
        return ret;
    }

    ......
}

int PNode :: Init(const Options & oOptions, NetWork *& poNetWork)
{
    ......
    
    /*为每一个paxos group创建Group实例*/
    for (int iGroupIdx = 0; iGroupIdx < oOptions.iGroupCount; iGroupIdx++)
    {
        /*创建Group实例*/
        Group * poGroup = new Group(poLogStorage, poNetWork, m_vecMasterList[iGroupIdx]->GetMasterSM(), iGroupIdx, oOptions);
        assert(poGroup != nullptr);
        m_vecGroupList.push_back(poGroup);
    }

    ......
}

Group :: Group(LogStorage * poLogStorage, 
            NetWork * poNetWork,    
            InsideSM * poMasterSM,
            const int iGroupIdx,
            const Options & oOptions) : 
    m_oCommunicate(&m_oConfig, oOptions.oMyNode.GetNodeID(), oOptions.iUDPMaxSize, poNetWork),
    /*调用Config构造函数，通过oOptions.vecNodeInfoList传递进来初始化的集群节点集合*/
    m_oConfig(poLogStorage, oOptions.bSync, oOptions.iSyncInterval, oOptions.bUseMembership, 
            oOptions.oMyNode, oOptions.vecNodeInfoList, oOptions.vecFollowerNodeInfoList, 
            iGroupIdx, oOptions.iGroupCount, oOptions.pMembershipChangeCallback),
    m_oInstance(&m_oConfig, poLogStorage, &m_oCommunicate, oOptions),
    m_iInitRet(-1), m_poThread(nullptr)
{
    m_oConfig.SetMasterSM(poMasterSM);
}

Config :: Config(
        const LogStorage * poLogStorage,
        const bool bLogSync,
        const int iSyncInterval,
        const bool bUseMembership,
        const NodeInfo & oMyNode, 
        const NodeInfoList & vecNodeInfoList,
        const FollowerNodeInfoList & vecFollowerNodeInfoList,
        const int iMyGroupIdx,
        const int iGroupCount,
        MembershipChangeCallback pMembershipChangeCallback)
    : m_bLogSync(bLogSync), 
    m_iSyncInterval(iSyncInterval),
    m_bUseMembership(bUseMembership),
    m_iMyNodeID(oMyNode.GetNodeID()), 
    m_iNodeCount(vecNodeInfoList.size()), 
    m_iMyGroupIdx(iMyGroupIdx),
    m_iGroupCount(iGroupCount),
    m_oSystemVSM(iMyGroupIdx, oMyNode.GetNodeID(), poLogStorage, pMembershipChangeCallback),
    m_poMasterSM(nullptr)
{
    /*初始化的集群节点集合*/
    m_vecNodeInfoList = vecNodeInfoList;

    m_bIsIMFollower = false;
    m_iFollowToNodeID = nullnode;

    for (auto & oFollowerNodeInfo : vecFollowerNodeInfoList)
    {
        if (oFollowerNodeInfo.oMyNode.GetNodeID() == oMyNode.GetNodeID())
        {
            PLG1Head("I'm follower, ip %s port %d nodeid %lu",
                    oMyNode.GetIP().c_str(), oMyNode.GetPort(), oMyNode.GetNodeID());
            m_bIsIMFollower = true;
            m_iFollowToNodeID = oFollowerNodeInfo.oFollowNode.GetNodeID();

            InsideOptions::Instance()->SetAsFollower();
        }
    }
}

Node :: RunNode
    - PNode :: Init
        - Group :: StartInit()
            - Group :: Init()
                - Config :: Init

int Config :: Init()
{
    int ret = m_oSystemVSM.Init();
    if (ret != 0)
    {
        PLG1Err("fail, ret %d", ret);
        return ret;
    }

    /*添加初始化的集群节点集合到SystemVariables中*/
    m_oSystemVSM.AddNodeIDList(m_vecNodeInfoList);

    PLG1Head("OK");
    return 0;
}

void SystemVSM :: AddNodeIDList(const NodeInfoList & vecNodeInfoList)
{
    if (m_oSystemVariables.gid() != 0)
    {
        PLG1Err("No need to add, i already have membership info.");
        return;
    }

    /*重置集群成员信息*/
    m_setNodeID.clear();
    m_oSystemVariables.clear_membership();

    /*将@vecNodeInfoList中的集群成员集合添加到SystemVariables @m_oSystemVariables中*/
    for (auto & tNodeInfo : vecNodeInfoList)
    {
        PaxosNodeInfo * poNodeInfo = m_oSystemVariables.add_membership();
        //to do, what rid?
        poNodeInfo->set_rid(0);
        poNodeInfo->set_nodeid(tNodeInfo.GetNodeID());

        NodeInfo tTmpNode(poNodeInfo->nodeid());
    }

    /*更新@m_setNodeID，并在指定了成员组变更回调的情况下调用该回调函数*/
    RefleshNodeID();
}

void SystemVSM :: RefleshNodeID()
{
    m_setNodeID.clear();

    NodeInfoList vecNodeInfoList;
    
    /*将SystemVariables @m_oSystemVariables中的节点信息添加到@m_setNodeID中*/
    for (int i = 0; i < m_oSystemVariables.membership_size(); i++)
    {
        PaxosNodeInfo oNodeInfo = m_oSystemVariables.membership(i);
        NodeInfo tTmpNode(oNodeInfo.nodeid());

        PLG1Head("ip %s port %d nodeid %lu", 
                tTmpNode.GetIP().c_str(), tTmpNode.GetPort(), tTmpNode.GetNodeID());

        m_setNodeID.insert(tTmpNode.GetNodeID());

        vecNodeInfoList.push_back(tTmpNode);
    }

    /*调用成员组变更回调函数*/
    if (m_pMembershipChangeCallback != nullptr)
    {
        m_pMembershipChangeCallback(m_iMyGroupIdx, vecNodeInfoList);
    }
}
```

### 在某个节点上发起第一个（关于任何提议的）Propose操作

```
/*处理接收到的消息、提议和retry事件*/
void IOLoop :: OneLoop(const int iTimeoutMs)
{
    std::string * psMessage = nullptr;

    m_oMessageQueue.lock();
    bool bSucc = m_oMessageQueue.peek(psMessage, iTimeoutMs);
    
    if (!bSucc)
    {
        m_oMessageQueue.unlock();
    }
    else
    {
        m_oMessageQueue.pop();
        m_oMessageQueue.unlock();

        /*处理接收到的消息*/
        if (psMessage != nullptr && psMessage->size() > 0)
        {
            m_iQueueMemSize -= psMessage->size();
            m_poInstance->OnReceive(*psMessage);
        }

        delete psMessage;

        BP->GetIOLoopBP()->OutQueueMsg();
    }

    /*处理retry事件*/
    DealWithRetry();

    /*处理新的提议*/
    m_poInstance->CheckNewValue();
}

void Instance :: CheckNewValue()
{
    /*检查是否是新的提议*/
    if (!m_oCommitCtx.IsNewCommit())
    {
        return;
    }

    /*检查本地Learner是否对齐*/
    if (!m_oLearner.IsIMLatest())
    {
        return;
    }

    /*Follower不参与协议*/
    if (m_poConfig->IsIMFollower())
    {
        PLGErr("I'm follower, skip this new value");
        m_oCommitCtx.SetResultOnlyRet(PaxosTryCommitRet_Follower_Cannot_Commit);
        return;
    }

    /*我不在成员组中*/
    if (!m_poConfig->CheckConfig())
    {
        PLGErr("I'm not in membership, skip this new value");
        m_oCommitCtx.SetResultOnlyRet(PaxosTryCommitRet_Im_Not_In_Membership);
        return;
    }

    /*提议过大*/
    if ((int)m_oCommitCtx.GetCommitValue().size() > MAX_VALUE_SIZE)
    {
        PLGErr("value size %zu to large, skip this new value",
            m_oCommitCtx.GetCommitValue().size());
        m_oCommitCtx.SetResultOnlyRet(PaxosTryCommitRet_Value_Size_TooLarge);
        return;
    }

    /*分配一个InstanceID*/
    m_oCommitCtx.StartCommit(m_oProposer.GetInstanceID());

    /*为本次提交添加定时器*/
    if (m_oCommitCtx.GetTimeoutMs() != -1)
    {
        m_oIOLoop.AddTimer(m_oCommitCtx.GetTimeoutMs(), Timer_Instance_Commit_Timeout, m_iCommitTimerID);
    }
    
    m_oTimeStat.Point();

    if (m_poConfig->GetIsUseMembership()
            && (m_oProposer.GetInstanceID() == 0 || m_poConfig->GetGid() == 0))
    {
        /*如果启用了成员组管理，且是第一个提议，则先提议初始化成员组*/
        PLGHead("Need to init system variables, Now.InstanceID %lu Now.Gid %lu", 
                m_oProposer.GetInstanceID(), m_poConfig->GetGid());

        /* 生成Gid，并提议以该Gid和集群成员信息（在Node :: RunNode -> PNode :: Init
         * -> Group :: StartInit -> Group :: Init -> Config :: Init -> 
         * SystemVSM :: AddNodeIDList中初始化了集群成员信息）来初始化成员组
         */
        uint64_t llGid = OtherUtils::GenGid(m_poConfig->GetMyNodeID());
        string sInitSVOpValue;
        int ret = m_poConfig->GetSystemVSM()->CreateGid_OPValue(llGid, sInitSVOpValue);
        assert(ret == 0);

        /*提议*/
        m_oSMFac.PackPaxosValue(sInitSVOpValue, m_poConfig->GetSystemVSM()->SMID());
        /*由Proposer执行Prepare + Accept，会广播消息给各Acceptor*/
        m_oProposer.NewValue(sInitSVOpValue);
    }
    else
    {
        if (m_oOptions.bOpenChangeValueBeforePropose) {
            m_oSMFac.BeforePropose(m_poConfig->GetMyGroupIdx(), m_oCommitCtx.GetCommitValue());
        }
        
        /*由Proposer执行Prepare + Accept，会广播消息给各Acceptor*/
        m_oProposer.NewValue(m_oCommitCtx.GetCommitValue());
    }
}

int SystemVSM :: CreateGid_OPValue(const uint64_t llGid, std::string & sOpValue)
{
    SystemVariables oVariables = m_oSystemVariables;
    /*设置Gid*/
    oVariables.set_gid(llGid);

    /*序列化@oVariables，其中包含Gid和集群成员信息*/
    bool sSucc = oVariables.SerializeToString(&sOpValue);
    if (!sSucc)
    {
        PLG1Err("Variables.Serialize fail");
        return -1;
    }

    return 0;
}

```

### 关于初始化成员组信息的提议多数派通过

```
void Proposer :: OnAcceptReply(const PaxosMsg & oPaxosMsg)
{
    ......

    if (m_oMsgCounter.IsPassedOnThisRound())
    {
        /*多数派通过*/
        int iUseTimeMs = m_oTimeStat.Point();
        BP->GetProposerBP()->AcceptPass(iUseTimeMs);
        PLGImp("[Pass] Start send learn, usetime %dms", iUseTimeMs);
        ExitAccept();
        /*本地Learner广播提案成功的消息给其它各Learner*/
        m_poLearner->ProposerSendSuccess(GetInstanceID(), m_oProposerState.GetProposalID());
    }
    else if (m_oMsgCounter.IsRejectedOnThisRound()
            || m_oMsgCounter.IsAllReceiveOnThisRound())
    {
        /*未通过*/
        BP->GetProposerBP()->AcceptNotPass();
        PLGImp("[Not pass] wait 30ms and Restart prepare");
        AddAcceptTimer(OtherUtils::FastRand() % 30 + 10);
    }
}

void Learner :: ProposerSendSuccess(
        const uint64_t llLearnInstanceID,
        const uint64_t llProposalID)
{
    BP->GetLearnerBP()->ProposerSendSuccess();

    PaxosMsg oPaxosMsg;
    
    oPaxosMsg.set_msgtype(MsgType_PaxosLearner_ProposerSendSuccess);
    oPaxosMsg.set_instanceid(llLearnInstanceID);
    oPaxosMsg.set_nodeid(m_poConfig->GetMyNodeID());
    oPaxosMsg.set_proposalid(llProposalID);
    oPaxosMsg.set_lastchecksum(GetLastChecksum());

    //run self first
    BroadcastMessage(oPaxosMsg, BroadcastMessage_Type_RunSelf_First);
}
```

### 各节点上的Learner接收到提案成功的消息，运用决议到状态机

```
int Instance :: ReceiveMsgForLearner(const PaxosMsg & oPaxosMsg)
{
    ......
    
    else if (oPaxosMsg.msgtype() == MsgType_PaxosLearner_ProposerSendSuccess)
    {
        /*接收到提案成功的消息*/
        m_oLearner.OnProposerSendSuccess(oPaxosMsg);
    }
    
    ......

    /*成功学习到决议*/
    if (m_oLearner.IsLearned())
    {
        BP->GetInstanceBP()->OnInstanceLearned();

        SMCtx * poSMCtx = nullptr;
        /* 当前学习到的决议对应的是否是我自己提出的最新的提案（因为只有一个
         * Committer，所以只有一个Learner在IsMyCommit的时候返回true）
         */
        bool bIsMyCommit = m_oCommitCtx.IsMyCommit(m_oLearner.GetInstanceID(), m_oLearner.GetLearnValue(), poSMCtx);

        if (!bIsMyCommit)
        {
            BP->GetInstanceBP()->OnInstanceLearnedNotMyCommit();
            PLGDebug("this value is not my commit");
        }
        else
        {
            int iUseTimeMs = m_oTimeStat.Point();
            BP->GetInstanceBP()->OnInstanceLearnedIsMyCommit(iUseTimeMs);
            PLGHead("My commit ok, usetime %dms", iUseTimeMs);
        }

        /* 无论该学习到的决议对应的是否是我提交的提案，都运用该决议到状态机
         * （以实现状态机状态切换），这里会针对当前group中所挂载的所有状态机
         * 上运用该决议，对于成员组变更来说，也有其自己的状态机，即SystemVSM，
         * 所以最终会执行到SystemVSM :: Execute
         */
        if (!SMExecute(m_oLearner.GetInstanceID(), m_oLearner.GetLearnValue(), bIsMyCommit, poSMCtx))
        {
            BP->GetInstanceBP()->OnInstanceLearnedSMExecuteFail();

            PLGErr("SMExecute fail, instanceid %lu, not increase instanceid", m_oLearner.GetInstanceID());
            /* SetResult中会设置该提案的执行结果，并设置CommitCtx::m_bIsCommitEnd
             * 为true，同时唤醒正在等待提案执行结果的Committer(Committer通过
             * CommitCtx::GetResult同步等待当前提案的执行结果，CommitCtx :: SetResult
             * 则唤醒之)
             */
            m_oCommitCtx.SetResult(PaxosTryCommitRet_ExecuteFail, 
                    m_oLearner.GetInstanceID(), m_oLearner.GetLearnValue());

            m_oProposer.CancelSkipPrepare();

            return -1;
        }
        
        {
            /*设置本次提交的结果为OK*/
            m_oCommitCtx.SetResult(PaxosTryCommitRet_OK
                    , m_oLearner.GetInstanceID(), m_oLearner.GetLearnValue());

            if (m_iCommitTimerID > 0)
            {
                m_oIOLoop.RemoveTimer(m_iCommitTimerID);
            }
        }
        
        m_iLastChecksum = m_oLearner.GetNewChecksum();

        /*为下一个提议做准备（增长InstanceID）*/
        NewInstance();

        /*设置当前已经成功运用到状态机的决议对应的最大InstanceID*/
        m_oCheckpointMgr.SetMaxChosenInstanceID(m_oAcceptor.GetInstanceID());

        BP->GetInstanceBP()->NewInstance();
    }

    return 0;
}

void Learner :: OnProposerSendSuccess(const PaxosMsg & oPaxosMsg)
{
    BP->GetLearnerBP()->OnProposerSendSuccess();

    /*InstanceID不匹配*/
    if (oPaxosMsg.instanceid() != GetInstanceID())
    {
        //Instance id not same, that means not in the same instance, ignord.
        PLGDebug("InstanceID not same, skip msg");
        return;
    }

    /*尚未接受任何的提案*/
    if (m_poAcceptor->GetAcceptorState()->GetAcceptedBallot().isnull())
    {
        //Not accept any yet.
        BP->GetLearnerBP()->OnProposerSendSuccessNotAcceptYet();
        PLGDebug("I haven't accpeted any proposal");
        return;
    }

    BallotNumber oBallot(oPaxosMsg.proposalid(), oPaxosMsg.nodeid());

    /*和Acceptor已经接受的最新的提案不匹配*/
    if (m_poAcceptor->GetAcceptorState()->GetAcceptedBallot()
            != oBallot)
    {
        //Proposalid not same, this accept value maybe not chosen value.
        PLGDebug("ProposalBallot not same to AcceptedBallot");
        BP->GetLearnerBP()->OnProposerSendSuccessBallotNotSame();
        return;
    }

    /*学习（最新成功的）提案，只在内存中更新学习到的提案内容*/
    m_oLearnerState.LearnValueWithoutWrite(
            oPaxosMsg.instanceid(),
            m_poAcceptor->GetAcceptorState()->GetAcceptedValue(),
            m_poAcceptor->GetAcceptorState()->GetChecksum());
    
    BP->GetLearnerBP()->OnProposerSendSuccessSuccessLearn();

    PLGHead("END Learn value OK, value %zu", m_poAcceptor->GetAcceptorState()->GetAcceptedValue().size());

    /*转发给各Follower*/
    TransmitToFollower();
}

void LearnerState :: LearnValueWithoutWrite(const uint64_t llInstanceID, 
        const std::string & sValue, const uint32_t iNewChecksum)
{
    /*更新学习到的最新的决议*/
    m_sLearnedValue = sValue;
    /*设置成功学习到了最新的决议*/
    m_bIsLearned = true;
    m_iNewChecksum = iNewChecksum;
}

bool SystemVSM :: Execute(const int iGroupIdx, const uint64_t llInstanceID, const std::string & sValue, SMCtx * poSMCtx)
{
    SystemVariables oVariables;
    /*从@sValue中解析出@ovVariables*/
    bool bSucc = oVariables.ParseFromArray(sValue.data(), sValue.size());
    if (!bSucc)
    {
        PLG1Err("Variables.ParseFromArray fail, bufferlen %zu", sValue.size());
        return false;
    }

    int * smret = nullptr;
    /* 对于成员组管理来说，在初始化集群成员组的时候，poSMCtx->m_pCtx为nullptr，
     * 只有在更新集群成员组的时候，才会设置poSMCtx->m_pCtx不为nullptr
     */
    if (poSMCtx != nullptr && poSMCtx->m_pCtx != nullptr)
    {
        /*@smret用于保存该决议运用结果*/
        smret = (int *)poSMCtx->m_pCtx;
    }

    /* 如果Gid不为0，且新的决议中的Gid跟当前的Gid不匹配，则直接返回，
     * 对于初始化集群成员组来说，当前Gid为0，所以会执行后续逻辑
     */
    if (m_oSystemVariables.gid() != 0 && oVariables.gid() != m_oSystemVariables.gid())
    {
        PLG1Err("modify.gid %lu not equal to now.gid %lu", oVariables.gid(), m_oSystemVariables.gid());
        if (smret != nullptr) *smret = Paxos_MembershipOp_GidNotSame;
        return true;
    }

    /*Version信息不匹配，对于初始化成员组来说，当前的Version是-1，决议中的Version也是-1*/
    if (oVariables.version() != m_oSystemVariables.version())
    {
        PLG1Err("modify.version %lu not equal to now.version %lu", oVariables.version(), m_oSystemVariables.version());
        if (smret != nullptr) *smret = Paxos_MembershipOp_VersionConflit;
        return true;
    }

    /*更新Version为当前最新的InstanceID @llInstanceID*/
    oVariables.set_version(llInstanceID);
    /*更新成员组信息，即SystemVariables*/
    int ret = UpdateSystemVariables(oVariables);
    if (ret != 0)
    {
        return false;
    }

    /*设置成功运用该决议（更新成员组信息）*/
    if (smret != nullptr) *smret = 0;

    return true;
}

int SystemVSM :: UpdateSystemVariables(const SystemVariables & oVariables)
{
    WriteOptions oWriteOptions;
    oWriteOptions.bSync = true;

    /*在LogStorage中写入group @m_iMyGroupIdx最新的成员组信息*/
    int ret = m_oSystemVStore.Write(oWriteOptions, m_iMyGroupIdx, oVariables);
    if (ret != 0)
    {
        PLG1Err("SystemVStore::Write fail, ret %d", ret);
        return -1;
    }

    /*更新内存中维护的最新成员组信息*/
    m_oSystemVariables = oVariables;

    /*更新@m_setNodeID，并调用注册的成员组变更的回调函数*/
    RefleshNodeID();

    return 0;
}

void SystemVSM :: RefleshNodeID()
{
    m_setNodeID.clear();

    NodeInfoList vecNodeInfoList;
    
    /*更新@m_setNodeID*/
    for (int i = 0; i < m_oSystemVariables.membership_size(); i++)
    {
        PaxosNodeInfo oNodeInfo = m_oSystemVariables.membership(i);
        NodeInfo tTmpNode(oNodeInfo.nodeid());

        PLG1Head("ip %s port %d nodeid %lu", 
                tTmpNode.GetIP().c_str(), tTmpNode.GetPort(), tTmpNode.GetNodeID());

        m_setNodeID.insert(tTmpNode.GetNodeID());

        vecNodeInfoList.push_back(tTmpNode);
    }

    /*调用注册的成员组变更的回调函数*/
    if (m_pMembershipChangeCallback != nullptr)
    {
        m_pMembershipChangeCallback(m_iMyGroupIdx, vecNodeInfoList);
    }
}
```

### 获取当前的成员组信息

```
int PNode :: ShowMembership(const int iGroupIdx, NodeInfoList & vecNodeInfoList)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*获取当前group的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    uint64_t llVersion = 0;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    return 0;
}

void SystemVSM :: GetMembership(NodeInfoList & vecNodeInfoList, uint64_t & llVersion)
{
    //must must get version first!
    llVersion = m_oSystemVariables.version();

    /*将SystemVariables中的成员组信息转换为@vecNodeInfoList，返回给调用者*/
    for (int i = 0; i < m_oSystemVariables.membership_size(); i++)
    {
        PaxosNodeInfo oNodeInfo = m_oSystemVariables.membership(i);

        NodeInfo tTmpNode(oNodeInfo.nodeid());
        vecNodeInfoList.push_back(tTmpNode);
    }
}
```

## 在已有集群新增节点
- 准备好新的节点，新的节点以空成员启动PhxPaxos(Options::vecNodeInfoList设置为空)。
- 在任意一个已有的集群成员节点中调用Node::AddMember。

### 在当前已存在的某个集群成员节点中调用Node::AddMember

```
int PNode :: AddMember(const int iGroupIdx, const NodeInfo & oNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /* 集群尚未确定Gid（应该在第一个提案被提交的时候触发集群成员组Gid的确定逻辑，
     * 见“初始化集群成员组”）
     */
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    /*返回成员组中的成员集合@vecNodeInfoList和版本号@llVersion*/
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    /*检查即将添加的节点是否已经在成员组中，如果在，则返回*/
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oNode.GetNodeID())
        {
            return Paxos_MembershipOp_Add_NodeExist;
        }
    }

    /* 添加到临时的成员组信息@vecNodeInfoList中，该临时成员组信息将用于
     * 发起成员组变更的提议
     */
    vecNodeInfoList.push_back(oNode);

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecNodeInfoList, llVersion);
}

int PNode :: ProposalMembership(
        SystemVSM * poSystemVSM, 
        const int iGroupIdx, 
        const NodeInfoList & vecNodeInfoList, 
        const uint64_t llVersion)
{
    string sOpValue;
    /*序列化新的成员组信息（新的成员组节点信息存放于@vecNodeInfoList中）*/
    int ret = poSystemVSM->Membership_OPValue(vecNodeInfoList, llVersion, sOpValue);
    if (ret != 0)
    {
        return Paxos_SystemError;
    }

    SMCtx oCtx;
    int smret = -1;
    /*成员组管理特定的SMID（state machine ID）*/
    oCtx.m_iSMID = SYSTEM_V_SMID;
    /*成员组管理提案执行结果存放于此*/
    oCtx.m_pCtx = (void *)&smret;

    /*提议*/
    uint64_t llInstanceID = 0;
    ret = Propose(iGroupIdx, sOpValue, llInstanceID, &oCtx);
    if (ret != 0)
    {
        return ret;
    }

    return smret;
}

int SystemVSM :: Membership_OPValue(const NodeInfoList & vecNodeInfoList, const uint64_t llVersion, std::string & sOpValue)
{
    SystemVariables oVariables;
    /*设置版本号和Gid*/
    oVariables.set_version(llVersion);
    oVariables.set_gid(m_oSystemVariables.gid());
    
    for (auto & tNodeInfo : vecNodeInfoList)
    {
        PaxosNodeInfo * poNodeInfo = oVariables.add_membership();
        //to do, what rid?
        poNodeInfo->set_rid(0);
        poNodeInfo->set_nodeid(tNodeInfo.GetNodeID());
    }

    /*序列化当前的成员组信息*/
    bool sSucc = oVariables.SerializeToString(&sOpValue);
    if (!sSucc)
    {
        PLG1Err("Variables.Serialize fail");
        return -1;
    }

    return 0;
}

int PNode :: Propose(const int iGroupIdx, const std::string & sValue, uint64_t & llInstanceID, SMCtx * poSMCtx)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*找到该paxos group的Committer提交之*/
    return m_vecGroupList[iGroupIdx]->GetCommitter()->NewValueGetID(sValue, llInstanceID, poSMCtx);
}

int Committer :: NewValueGetID(const std::string & sValue, uint64_t & llInstanceID, SMCtx * poSMCtx)
{
    BP->GetCommiterBP()->NewValue();

    /*重试至多3次*/
    int iRetryCount = 3;
    int ret = PaxosTryCommitRet_OK;
    while(iRetryCount--)
    {
        TimeStat oTimeStat;
        oTimeStat.Point();

        /*提交提案，这里会同步等待提案执行结果*/
        ret = NewValueGetIDNoRetry(sValue, llInstanceID, poSMCtx);
        if (ret != PaxosTryCommitRet_Conflict)
        {
            /*如果提案执行完毕，没有冲突，则退出*/
            if (ret == 0)
            {
                BP->GetCommiterBP()->NewValueCommitOK(oTimeStat.Point());
            }
            else
            {
                BP->GetCommiterBP()->NewValueCommitFail();
            }
            break;
        }

        BP->GetCommiterBP()->NewValueConflict();

        /*本提案和其它提案存在冲突，需要重试，但是关于Master的提案不重试*/
        if (poSMCtx != nullptr && poSMCtx->m_iSMID == MASTER_V_SMID)
        {
            //master sm not retry
            break;
        }
    }

    return ret;
}

int Committer :: NewValueGetIDNoRetry(const std::string & sValue, uint64_t & llInstanceID, SMCtx * poSMCtx)
{
    LogStatus();

    int iLockUseTimeMs = 0;
    /* 尝试申请锁，至多等待@m_iTimeoutMs的时间，如果成功申请到锁，或者该锁等待超时，
     * 则返回该锁申请所花费的时间，如果成功申请到锁，则返回true，否则返回false
     */
    bool bHasLock = m_oWaitLock.Lock(m_iTimeoutMs, iLockUseTimeMs);
    if (!bHasLock)
    {
        /*没有申请到锁*/
        
        if (iLockUseTimeMs > 0)
        {
            /*该请求等待超时了*/
            BP->GetCommiterBP()->NewValueGetLockTimeout();
            PLGErr("Try get lock, but timeout, lockusetime %dms", iLockUseTimeMs);
            return PaxosTryCommitRet_Timeout; 
        }
        else
        {
            /*有过多的请求在等待，所以本请求不能进入等待队列，直接被拒绝了*/
            BP->GetCommiterBP()->NewValueGetLockReject();
            PLGErr("Try get lock, but too many thread waiting, reject");
            return PaxosTryCommitRet_TooManyThreadWaiting_Reject;
        }
    }

    /*成功申请到锁*/
    int iLeftTimeoutMs = -1;
    if (m_iTimeoutMs > 0)
    {
        iLeftTimeoutMs = m_iTimeoutMs > iLockUseTimeMs ? m_iTimeoutMs - iLockUseTimeMs : 0;
        if (iLeftTimeoutMs < 200)
        {
            /*但是获取锁花费的时间太长了，释放锁，重新申请*/
            PLGErr("Get lock ok, but lockusetime %dms too long, lefttimeout %dms", iLockUseTimeMs, iLeftTimeoutMs);

            BP->GetCommiterBP()->NewValueGetLockTimeout();

            m_oWaitLock.UnLock();
            return PaxosTryCommitRet_Timeout;
        }
    }

    PLGImp("GetLock ok, use time %dms", iLockUseTimeMs);
    
    BP->GetCommiterBP()->NewValueGetLockOK(iLockUseTimeMs);

    //pack smid to value
    /*获取SMID，并打包到提议中*/
    int iSMID = poSMCtx != nullptr ? poSMCtx->m_iSMID : 0;
    
    string sPackSMIDValue = sValue;
    m_poSMFac->PackPaxosValue(sPackSMIDValue, iSMID);

    /*初始化CommitCtx*/
    m_poCommitCtx->NewCommit(&sPackSMIDValue, poSMCtx, iLeftTimeoutMs);
    /* 添加一个空消息（nullptr）到IOLoop中（IOLoop拥有独立的线程），
     * 在IOLoop中该消息会被调度处理
     */
    m_poIOLoop->AddNotify();

    /* 等待提交（Commit）的结果（会同步等待，直到该提案执行完毕），
     * 如果成功提交，则返回对应的InstanceID
     */
    int ret = m_poCommitCtx->GetResult(llInstanceID);

    m_oWaitLock.UnLock();
    return ret;
}

void CommitCtx :: NewCommit(std::string * psValue, SMCtx * poSMCtx, const int iTimeoutMs)
{
    m_oSerialLock.Lock();

    m_llInstanceID = (uint64_t)-1;
    m_iCommitRet = -1;
    m_bIsCommitEnd = false;
    m_iTimeoutMs = iTimeoutMs;

    m_psValue = psValue;
    m_poSMCtx = poSMCtx;

    if (psValue != nullptr)
    {
        PLGHead("OK, valuesize %zu", psValue->size());
    }

    m_oSerialLock.UnLock();
}

void CommitCtx :: StartCommit(const uint64_t llInstanceID)
{
    m_oSerialLock.Lock();
    /*设置Instance ID*/
    m_llInstanceID = llInstanceID;
    m_oSerialLock.UnLock();
}

int CommitCtx :: GetResult(uint64_t & llSuccInstanceID)
{
    m_oSerialLock.Lock();

    /* 在NewCommit中@m_bIsCommitEnd被设置为false，等待直到@m_IsCommitEnd被设置为true，
     * 也就是等待该提案执行完毕（可能成功，也可能失败）
     */
    while (!m_bIsCommitEnd)
    {
        m_oSerialLock.WaitTime(1000);
    }

    if (m_iCommitRet == 0)
    {
        /*提交成功，则返回对应的Instance ID*/
        llSuccInstanceID = m_llInstanceID;
        PLGImp("commit success, instanceid %lu", llSuccInstanceID);
    }
    else
    {
        PLGErr("commit fail, ret %d", m_iCommitRet);
    }
    
    m_oSerialLock.UnLock();

    return m_iCommitRet;
}

接着执行如下逻辑：
1. 进入到IOLoop中处理该Committer提交的提议，参考“初始化集群成员组”中
IOLoop::OneLoop的分析，最终该提案会经由Proposer执行Paxos协议。
2. 该提案成功获得多数派，参考“初始化集群成员组”中Proposer::OnAcceptReply
的分析，最终会被各Learner学习到，并且运用到状态机中。
3. 由于该提案的内容是原来的集群成员组节点加上新添加的节点，在决议被成功
运用到成员组管理的状态机之后，新的成员组中就会包含该新添加的节点。
```

## 在已有集群替换节点
- 准备好新的节点，新的节点以空成员启动PhxPaxos(Options::vecNodeInfoList设置为空)。
- 在任意一个已有的集群成员节点中调用Node::ChangeMember。

### 在当前已存在的某个集群成员节点中调用Node::ChangeMember

```
/*将某个节点信息从@oFromNode更改为@oToNode*/
int PNode :: ChangeMember(const int iGroupIdx, const NodeInfo & oFromNode, const NodeInfo & oToNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /* 集群尚未确定Gid（应该在第一个提案被提交的时候触发集群成员组Gid的确定逻辑，
     * 见“初始化集群成员组”）
     */
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    /*返回成员组中的成员集合@vecNodeInfoList和版本号@llVersion*/
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    NodeInfoList vecAfterNodeInfoList;
    bool bFromNodeExist = false;
    bool bToNodeExist = false;
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oFromNode.GetNodeID())
        {
            bFromNodeExist = true;
            continue;
        }
        else if (oNodeInfo.GetNodeID() == oToNode.GetNodeID())
        {
            bToNodeExist = true;
            continue;
        }

        /*@vecAfterNodeInfoList中已经排除了@oFromNode和@oToNode*/
        vecAfterNodeInfoList.push_back(oNodeInfo);
    }

    /*@oFromNode不存在，则不更改*/
    if ((!bFromNodeExist) && bToNodeExist)
    {
        return Paxos_MembershipOp_Change_NoChange;
    }

    /*将@oToNode添加到@vecAfterNodeInfoList中，表示更改后的集群节点集合*/
    vecAfterNodeInfoList.push_back(oToNode);

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecAfterNodeInfoList, llVersion);
}

接下来的逻辑请参考“在已有集群添加节点”。
```

## 在已有集群删除节点
- 在任意一个已有的成员节点中调用Node::RemoveMember。
- 如果所有节点都希望立即获得这个成员变更操作的通知，可通过options.h设置Options::pMembershipChangeCallback回调函数。

### 在当前已存在的某个集群成员节点中调用Node::RemoveMember
```
int PNode :: RemoveMember(const int iGroupIdx, const NodeInfo & oNode)
{
    if (!CheckGroupID(iGroupIdx))
    {
        return Paxos_GroupIdxWrong;
    }

    /*当前的成员组信息*/
    SystemVSM * poSystemVSM = m_vecGroupList[iGroupIdx]->GetConfig()->GetSystemVSM();

    /*集群尚未确定Gid*/
    if (poSystemVSM->GetGid() == 0)
    {
        return Paxos_MembershipOp_NoGid;
    }

    /*获取当前的成员组信息*/
    uint64_t llVersion = 0;
    NodeInfoList vecNodeInfoList;
    poSystemVSM->GetMembership(vecNodeInfoList, llVersion);

    bool bNodeExist = false;
    NodeInfoList vecAfterNodeInfoList;
    for (auto & oNodeInfo : vecNodeInfoList)
    {
        if (oNodeInfo.GetNodeID() == oNode.GetNodeID())
        {
            bNodeExist = true;
        }
        else
        {
            /*@vecAfterNodeInfoList中排除@oNode*/
            vecAfterNodeInfoList.push_back(oNodeInfo);
        }
    }

    if (!bNodeExist)
    {
        /*如果@oNode不在当前的成员组中，则直接返回*/
        return Paxos_MembershipOp_Remove_NodeNotExist;
    }

    /*发起成员组变更的提议*/
    return ProposalMembership(poSystemVSM, iGroupIdx, vecAfterNodeInfoList, llVersion);
}

接下来的逻辑请参考“在已有集群添加节点”。
```






